# 📸 Snap Organizer App – Requirements

## 🧩 背景

現在のアプリは以下の2つのタブ構成で動作しています：

- 単一写真読込（Tesseract + Google Cloud Vision APIによるOCR実装済）
- 複数写真一括読込

---

## 🚧 方針

- **UIは単一化**：単一・複数読込機能を1つのUIパネルに統合・・・OK
- **OCR処理・画像処理などパフォーマンスが要求される箇所には Rust（WASM）実装を基本とする**
- **データ保存・検索は IndexedDB（JSON形式）を使用**
- **完全オフライン対応を目指す（通信は共有時のみ）**

---

## 🎯 要求仕様

### 1. UIの統合

- 単一／複数写真読込を1画面に統合　OK
- 単一読込時には既存OCR処理を継続して利用　OK
- ユーザーが1枚か複数枚かを選択できるようにする　OK

### 2. 画像処理の仕組み

画像の向きと色が正しく保存される仕組みは以下の通り：

1. **画像の読み込みと変換**
   - FileReaderを使用してファイルをDataURL形式で読み込み
   - HTMLCanvasElementを使用して画像のリサイズを実行
   - Canvasのリサイズ処理により、自動的にEXIF情報に基づいた向き補正が適用

2. **2段階の画像処理**
   - 第1段階：Canvas APIによるリサイズ
     - `drawImage`メソッドが自動的にEXIF orientationを解釈
     - ブラウザネイティブの処理で高速かつ高品質なリサイズを実現
   - 第2段階：WASM（Rust）による色処理
     - リサイズ済み画像に対して色処理を適用
     - カラー情報を保持したまま処理を実行

3. **データの保存**
   - 処理済み画像をJPEG形式でエンコード
   - Base64形式でIndexedDBに保存
   - 向きと色情報が正規化された状態で永続化

4. **技術的な利点**
   - ブラウザネイティブのCanvas APIを活用することで、EXIF orientationの解釈を自動化
   - WASMモジュールは画像処理に特化し、パフォーマンスを最適化
   - 2段階処理により、各処理の責務を明確に分離

---

### 3. データ保存スキーマの整備

- 各写真読込時に以下の形式でJSONメタ情報を保存（IndexedDB使用）：

```json
{
  "filename": "uuid.jpg",
  "date_taken": "2025-06-18",
  "location": { "lat": 35.6, "lon": 139.7 },
  "tags": ["#仕事", "#趣味"],
  "ocr_text": "Rust...",
  "source": "single" // または "bulk"
}

インポート／エクスポート形式はJSONベースを継続

既存のデータとの互換性は考慮不要（データ消失OK）

---

### 4. 共有機能の実装

Web Share APIを使用し、以下のアプリと共有可能にする：

Gmail

Outlook

Yahoo Mail

Slack

AirDrop（iOS Safari）

非対応ブラウザには以下のフォールバックを提供：

mailto: リンク

Blob URLによるダウンロード

---

### 5. 将来の全文検索対応に備えた設計

ocr_text, tags, date_taken, location を構造的に保存

将来的に Rust × Tantivy などの全文検索と統合可能な形式に設計

最低限以下のUIを実装：

タグによるフィルタ

日付フィルタ

フリーワード検索窓

🧠 機能拡張案

6. 各写真に個別の共有ボタンを設置
各画像に navigator.share() を使った共有ボタンを表示

ユーザーが Gmail / Slack / Outlook / AirDrop などの送信先を個別に選択

非対応端末では前述のフォールバックを表示

7. 緯度・経度から地名へ変換
オフラインで動作する 簡易地名辞書（JSONファイル） を用意し、変換関数を実装

各画像に含まれる lat/lon をもとに、地名（例：「東京都港区」）を表示用に変換

地名辞書の形式例：

json
Copy
Edit
[
  {
    "name": "東京都港区",
    "lat_min": 35.63,
    "lat_max": 35.68,
    "lon_min": 139.72,
    "lon_max": 139.78
  }
]
🔚 備考
デバイス間の共有は JSONデータのインポート／エクスポート + UIを通じて行う

OCR結果が長大な場合は「要約＋全文」の併用保存を検討

ファイルとして保存する代わりに、メール本文やSlack投稿でJSON文字列を共有する方式も併用し、UXを改善する