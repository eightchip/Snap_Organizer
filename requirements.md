# 📸 Snap Organizer App – Requirements

## 🧩 背景

現在のアプリは以下の機能を実装済みです：

- 単一写真読込（Tesseract + Google Cloud Vision APIによるOCR実装済）
- 複数写真一括読込
- 画像の向き補正と色処理
- タグ管理とフィルタリング
- 共有機能（Web Share API）
- インポート/エクスポート機能

---

## 🚧 方針

- **UIは単一化**：単一・複数読込機能を1つのUIパネルに統合・・・✅
- **OCR処理・画像処理などパフォーマンスが要求される箇所には Rust（WASM）実装を基本とする**・・・✅
- **データ保存・検索は IndexedDB（JSON形式）を使用**・・・✅
- **完全オフライン対応を目指す（通信は共有時のみ）**・・・✅

---

## 🎯 実装済み機能

### 1. UIの統合 ✅
- 単一／複数写真読込を1画面に統合
- 単一読込時には既存OCR処理を継続して利用
- ユーザーが1枚か複数枚かを選択できる

### 2. 画像処理の仕組み ✅
画像の向きと色が正しく保存される仕組みは以下の通り：

1. **画像の読み込みと変換**
   - FileReaderを使用してファイルをDataURL形式で読み込み
   - HTMLCanvasElementを使用して画像のリサイズを実行
   - Canvasのリサイズ処理により、自動的にEXIF情報に基づいた向き補正が適用

2. **2段階の画像処理**
   - 第1段階：Canvas APIによるリサイズ
     - `drawImage`メソッドが自動的にEXIF orientationを解釈
     - ブラウザネイティブの処理で高速かつ高品質なリサイズを実現
   - 第2段階：WASM（Rust）による色処理
     - リサイズ済み画像に対して色処理を適用
     - カラー情報を保持したまま処理を実行

3. **データの保存**
   - 処理済み画像をJPEG形式でエンコード
   - Base64形式でIndexedDBに保存
   - 向きと色情報が正規化された状態で永続化

### 3. データ保存スキーマ ✅

各写真読込時に以下の形式でJSONメタ情報を保存（IndexedDB使用）：

```json
{
  "filename": "uuid.jpg",
  "date_taken": "2025-06-18",
  "location": { "lat": 35.6, "lon": 139.7 },
  "tags": ["#仕事", "#趣味"],
  "ocr_text": "Rust...",
  "source": "single" // または "bulk"
}
```

### 4. 共有機能 ✅

Web Share APIを使用し、以下のアプリと共有可能：
- Gmail
- Outlook
- Yahoo Mail
- Slack
- AirDrop（iOS Safari）

非対応ブラウザには以下のフォールバックを提供：
- Blob URLによるダウンロード

### 5. 検索機能 ✅

- タグによるフィルタリング
- 日付フィルター
- フリーワード検索（OCRテキスト、メモ）
- 検索結果のリアルタイム更新

---

## 🎯 未実装機能

### 1. 地名変換機能
- 緯度・経度から地名への変換機能
- オフライン地名辞書の実装
- 地名表示のUI統合

### 2. 全文検索の最適化
- Rust × Tantivy による全文検索エンジンの統合
- インデックス作成の最適化
- 検索パフォーマンスの向上

### 3. OCR結果の最適化
- OCR結果が長大な場合の要約機能
- 要約＋全文の併用保存機能

---

## 🔚 備考

- デバイス間の共有は JSONデータのインポート／エクスポート + UIを通じて実装済み
- メール本文やSlack投稿でのJSON文字列共有は未実装
- 地名変換機能は基本的なインターフェースは実装済みだが、辞書データの整備が必要

現在のSnap Organizerアプリでは、データのバックアップ・共有・インポート/エクスポート機能がUI上で混在しています。以下の方針で構成整理とUI統合をお願いします。

🎯 要件と改善指示
✅ インポート（現状維持）
インポートは現仕様のままでOK。

JSONファイルを読み込むか、

直接ペーストして JSON.parse() できるUI構成

このUIは問題なく、機能的に必要充分

✅ エクスポート／共有（統合が必要）
現在、「共有ボタン」と「エクスポートボタン」で**同じ処理（JSONの生成とダウンロード）**が発生しており、機能がダブっている。

🔄 現在の構成：
上下矢印アイコン = エクスポート（タグおよびデータをJSON出力）

ツリー（または共有）アイコン = 共有機能（QRコードやメール送信など）

❗ 問題点：
「共有」も「エクスポート」もJSONデータの生成という意味では同一処理

ユーザーにとって意味が重複し、UIが煩雑に見える

✅ 今後の統合方針
✅ 機能統合
「エクスポート/共有」ボタンを1つに統一

ボタン押下後に共有オプション選択モーダルを表示：

JSONダウンロード（ローカル保存）

メールアプリで送信（Gmail / Yahoo など起動）

（将来的な拡張）SlackやLINE共有など

✅ QRコード機能は廃止
QRによる共有（JSON分割や圧縮）は実装が煩雑でUXに不向きなため

QRコード生成・表示・読み取りは今後廃止とする

共有はメール送信ベースに一本化

✅ 推奨する「メール共有」仕様
JSONデータを生成

navigator.share() または mailto: URL を生成して送信

本文にそのまま貼り付け（または添付）

受け取り側は：

添付ファイルを取り込む

またはメール本文をコピペ → インポート画面に貼り付けで復元

💡 UI提案（最終構成イメージ）
アイコン	機能
🔄 回転矢印	バックアップ（IndexedDB→LocalBackup）
📤 エクスポート / 共有	統合ボタン（JSONをDL or メール送信）
📥 インポート	ファイル選択＋貼り付け（既存UI維持）

🧩 補足情報
現在左上にあるQRコードは「アプリURL共有用」として維持（再訪や端末移行に便利）

データ共有（写真＋タグ＋OCR）はすべてJSONで統一

受け取りは「貼り付け or ファイル選択」で簡単にできる

この方針に沿って、UIおよび機能構成を整理・実装してください。必要に応じて共有方法選択用のモーダルや、navigator.share() のフォールバック機能（非対応端末用のmailtoリンク生成）もお願いします。ちなみに現時点までの段階でデプロイをした際のエラーメッセージが添付のものです。上記方針に必要不可欠ならば同時にこのエラーにも対応をお願いします。